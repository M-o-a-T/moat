#!/usr/bin/env python3
"""
Pre-commit hook to run pytest only on test directories corresponding to modified files.

For a modified file like moat/foo/bar/baz.py, this will:
1. Look for tests/moat_foo_bar/ directory
2. If not found, look for tests/moat_foo/ directory
3. If not found, look for tests/ directory
4. Run pytest on all found test directories
"""

from __future__ import annotations

import subprocess
import sys
from pathlib import Path


def get_test_dir(filepath: str) -> Path | None:
    """
    Given a file path like moat/foo/bar/baz.py, return the corresponding test directory.

    Tries in order:
    - tests/moat_foo_bar/
    - tests/moat_foo/
    - tests/

    Returns None if file is not in moat/ or no test directory exists.
    """
    path = Path(filepath)

    # Only consider files in moat/ directory
    if not path.parts or path.parts[0] != "moat":
        return None

    # Extract module parts
    module_parts = path.parts[:-1]

    # Try progressively shorter paths
    while module_parts:
        test_dir = Path("tests") / "_".join(module_parts)
        if test_dir.is_dir():
            return test_dir
        module_parts.pop()
        if len(module_parts) < 2:
            break

    return None


def main(filenames: list[str]) -> int:
    """
    Main entry point for pre-commit hook.

    Args:
        filenames: List of modified files from pre-commit

    Returns:
        0 if tests pass, non-zero otherwise
    """
    # Collect unique test directories
    test_dirs = set()

    for filename in filenames:
        if (test_dir := get_test_dir(filename)) is not None:
            test_dirs.add(test_dir)

    # If no test directories found, nothing to test
    if not test_dirs:
        return 0

    # Run pytest on each test directory
    failed_dirs = []
    for test_dir in sorted(test_dirs):
        print(f"\n{'=' * 60}")
        print(f"Running tests in {test_dir}")
        print("=" * 60)

        result = subprocess.run(  # noqa:S603
            ["pytest", "-xv", str(test_dir)],  # noqa:S607
            check=False,
            env={"PYTHONPATH": "."},
        )

        if result.returncode != 0:
            failed_dirs.append(test_dir)

    # Report results
    if failed_dirs:
        print(f"\n{'=' * 60}")
        print("FAILED test directories:")
        for d in failed_dirs:
            print(f"  - {d}")
        print("=" * 60)
        return 1

    print(f"\n{'=' * 60}")
    print("All tests passed!")
    print("=" * 60)
    return 0


if __name__ == "__main__":
    sys.exit(main(sys.argv[1:]))
